{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block page_styles %}
    <!-- Config Page -->
    <link href="/css/configure.css" rel="stylesheet">
    <link href='//api.tiles.mapbox.com/mapbox.js/v1.6.0-beta0/mapbox.css' rel='stylesheet'>
{% endblock %}

{% block navbar %}
  {% include 'navbar.html' %}
{% endblock %}

{% block content %}
<div class="container content">
  <div class="row">

    {{ macros.nav_pills("systems", settings) }}

    <!-- form on right side -->
    <div class="col-md-10">

      <!-- form header -->
      <div class="row">
        <div class="col-md-12">
          <div class="section-header">
            <h2><small>Flavors & Images</small></h2>
            <p>Your appliance needs a minimum of one flavor and one image installed to provide service to users.  Click on the <strong>Install</strong> button next to the entries you want to install on your OpenStack cluster.  If you want to delete or pause a particular flavor or image, click on the <strong>Pause</strong> button next to the entry.</p>
            <p><em>Flavor and image types are synced hourly from the pool operator.  You can force a sync by clicking the button below.</em></p>
            <button class="btn btn-warning" id="sync-flavors-images"><span class="glyphicon glyphicon-refresh"></span> Sync Flavors & Images</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="section-header">
            <h2><small>System Flavors</small></h2>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Comment</th>
                <th class="text-center"># VPUs</th>
                <th class="text-center">Memory (in MB)</th>
                <th class="text-center">Disk (in GB)</th>
                <th class="text-center">State</th>
                <th class="text-center">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for flavor in flavors %}
                {% if flavor.osid and flavor.active %}
                  <tr class="success">
                {% else %}
                  <tr>
                {% endif %}
                <td>{{ flavor.id }}</td>
                <td>{{ flavor.name }}</td>
                <td>{{ flavor.comment }}</td>
                <td class="text-center">{{ flavor.vpu }}</td>
                <td class="text-center">{{ flavor.mem }}</td>
                <td class="text-center">{{ flavor.disk }}</td>
                {% if flavor.osid and flavor.active %}
                  <td class="text-center"><span class="glyphicon glyphicon-ok"></span></td>
                  <td class="text-center"><button id="flavor-install-{{ flavor.id }}" class="btn btn-sm btn-danger remove"><span class="glyphicon glyphicon-remove"></span> Delete</button></td>
                {% else %}
                  <td class="text-center"><span class="glyphicon glyphicon-remove"></span></td>
                  <td class="text-center"><button id="flavor-install-{{ flavor.id }}" class="btn btn-sm btn-success"><span class="glyphicon glyphicon-cloud-upload"></span> Install</button></td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="section-header">
            <h2><small>System Images</small></h2>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th class="text-center">Size (in B)</th>
                <th class="text-center">State</th>
                <th class="text-center">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for image in images %}
                {% if image.osid and image.active %}
                  <tr class="success">
                {% else %}
                  <tr>
                {% endif %}
                <td>{{ image.id }}</td>
                <td>{{ image.name }}</td>
                <td class="text-center">{{ image.size }}</td>
                {% if image.osid and image.active %}
                  <td class="text-center"><span class="glyphicon glyphicon-ok"></span></td>
                  <td class="text-center"><button id="image-install-{{ image.id }}" class="btn btn-sm btn-danger remove"><span class="glyphicon glyphicon-remove"></span> Delete</button></td>
                {% elif image.active %}
                  <td class="text-center"><span id="image-loading-{{ image.id }}"><img src="/img/loading.gif"/></span></td>
                  <td class="text-center"><button id="image-install-{{ image.id }}" class="btn btn-sm btn-warning" disabled><span class="glyphicon glyphicon-refresh"></span> Install</button></td>
                {% else %}
                  <td class="text-center"><span class="glyphicon glyphicon-remove"></span></td>
                  <td class="text-center"><button id="image-install-{{ image.id }}" class="btn btn-sm btn-success"><span class="glyphicon glyphicon-cloud-upload"></span> Install</button></td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
    <!-- end right side -->

  </div>
</div>
{% endblock %}

{% block javascript %}
  <script type="text/javascript">
    $().ready(function() {
      var csrf_token = "{{ csrf_token }}";
      
      // error modal settings link
      $('#failure-modal-settings').click(function() {
        window.open("{{ url_for("configure.configure_openstack") }}");
      });

      // flavor buttons
      $('button[id^="flavor-install-"]').each(function(index){
        $('#'+this.id).click(function() {
          flavor_id = this.id.split("-").pop();          
          if ($('#'+this.id).hasClass("remove")) {
            flavor_state = "remove";
          } else { 
            flavor_state = "install";
          }
          $.ajax({
            url: '/api/flavors/'+flavor_id+'/'+flavor_state+'?_csrf_token='+csrf_token,
            type: 'POST',
          }).done(function(data) {
           if (data.response.indexOf("fail") >= 0) {
              alertify.log("Could not install flavor.  Check your OpenStack settings!", "error");
              $("#openstack-settings").trigger('mouseenter');
            } else {
              location.reload();
            }
          });
        });
      });

      // image buttons
      $('button[id^="image-install-"]').each(function(index){
        $('#'+this.id).click(function() {
          image_id = this.id.split("-").pop();          
          if ($('#'+this.id).hasClass("remove")) {
            image_state = "remove";
          } else { 
            image_state = "install";
          }
          $.ajax({
            url: '/api/images/'+image_id+'/'+image_state+'?_csrf_token='+csrf_token,
            type: 'POST',
          }).done(function(data) {
            if (data.response.indexOf("fail") >= 0) {
              alertify.log("Could not install image.  Check your OpenStack settings!", "error");
              $("#openstack-settings").trigger('mouseenter');
            } else {
              location.reload();
            }
          });
        });
      });

      // look for loading image for images
      // more hackish bullshit due to glanceclient
      $('span[id^="image-loading-"]').each(function(index){
        image_id = this.id.split("-").pop();
        setInterval(function() {
          $.ajax({
            url: '/api/images/'+image_id+'/detail',
          }).done(function(data) {
            console.log(data.image.active);
            if (data.image.osid && data.image.active == 2) {
              location.reload();
            }
          });
        }, 3000);
      });

      // sync from remote pool button
      $('#sync-flavors-images').click(function(){
        console.log("sync");
        $.ajax({
          url: '{{ url_for("api.flavors_sync") }}',
        }).done(function() {
          $.ajax({
            url: '{{ url_for("api.images_sync") }}',
          }).done(function(data) {
            console.log(data);
            if (data.response.indexOf("fail") >= 0) {
              alertify.log("Could not establish a connection with the OpenStack cluster.  Check your settings!", "error");
              {% if config['DEBUG'] == True %}
                alertify.log(data.result, "info");
              {% endif %}
            } else {
              location.reload();
            }
          });
        });
      });
    });
  </script>

{% endblock %}

{% block extras %}
  <script src='/js/popovers.js'></script>
{% endblock %}
